<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map | Val Commuters</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@600&family=Lexend+Deca:wght@400;500&family=Libre+Franklin:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

  <style>
    #map {
      width: 100%;
      height: 300px;
      border-radius: 12px;
    }

    .stop-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .stop-row:hover {
      background: #e6f0ff;
    }

    .nearby-stops {
      max-height: 250px;
      overflow-y: auto;
      padding-right: 5px;
    }

    .nearby-stops::-webkit-scrollbar {
      width: 6px;
    }

    .nearby-stops::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="page-bg">
    <div class="main-card">
      <div class="logo-header">
        <img src="logo.png" alt="Logo" class="brand-logo">
        <div class="brand-text">
          <span>VAL COMMUTERS</span>
          <p>Your travel companion</p>
        </div>
      </div>

      <div class="form-header">
        <h2>Vehicle Routes in Valenzuela</h2>
      </div>

      <div class="route-legend">
        <h4>Routes:</h4>
        <div class="route-item">
          <span class="route-dot route-1"></span>
          <span>Route 1</span>
        </div>
        <div class="route-item">
          <span class="route-dot route-2"></span>
          <span>Route 2</span>
        </div>
        <div class="route-item">
          <span class="route-dot route-3"></span>
          <span>Route 3</span>
        </div>
      </div>

      <div id="routeOptionsContainer"></div>

      <div class="map-card">
        <div id="map"></div>
        <div class="location-info">
          <img src="icons/Map_Pin.svg" alt="Location Icon" class="location-icon">
          <span id="locationText">Maysan, Valenzuela City</span>
        </div>
      </div>

      <div class="route-card">
        <div class="nearby-stops" id="nearbyStopsContainer">
          <h3>
            <img src="icons/Paper_Plane.svg" alt="Stops Icon" class="stops-icon">
            Nearby Stops
          </h3>
          <div id="stopsListContainer"></div>
        </div>
      </div>

      <nav class="bottom-nav">
        <a href="routes.html" class="nav-item">
          <img src="icons/Paper_Plane.svg" alt="Routes" class="nav-icon">
          <span>Routes</span>
        </a>
        <a href="map.html" class="nav-item active">
          <img src="icons/Map_Pin.svg" alt="Map" class="nav-icon">
          <span>Map</span>
        </a>
        <a href="account.html" class="nav-item">
          <img src="icons/User_02.svg" alt="Account" class="nav-icon">
          <span>Account</span>
        </a>
      </nav>
    </div>
  </div>

  <script>
    const terminals = [
      { name: "VGC Terminal", coords: [120.9830, 14.7066] },
      { name: "Karuhatan Terminal", coords: [120.980, 14.710] },
      { name: "Maysan Terminal", coords: [120.985, 14.715] },
      { name: "Mavanoda Terminal", coords: [120.972370, 14.693850] },
      { name: "MASTODA Terminal", coords: [120.9785331, 14.6821576] },
      { name: "MASTODA Sub - Terminal 1", coords: [120.9800703, 14.6810202] },
      { name: "MASTODA Sub - Terminal 3", coords: [120.9822409, 14.6807525] },
      { name: "FATATODA Terminal", coords: [120.9801478, 14.6786276] },
      { name: "FATATODA Sub - Terminal", coords: [120.9811110, 14.6790483] },
      { name: "FATATODA Terminal 2", coords: [120.9834875, 14.6804238] },
      { name: "ASCTODA Terminal", coords: [120.9780111, 14.6824262] },
      { name: "ASCTODA Terminal 2", coords: [120.9758491, 14.6859664] },
      { name: "MTODA Terminal 1", coords: [120.9827228, 14.6740721] },
      { name: "MTODA Terminal 2", coords: [120.990848, 14.675692] },
      { name: "MTODA Terminal 3", coords: [120.992750, 14.677758] },
      { name: "MTODA Terminal 4 (Liwayway)", coords: [120.994981, 14.680327] },
      { name: "EFPTODA Terminal", coords: [120.981136, 14.674267] },
      { name: "DOPTODA Terminal", coords: [120.9778165, 14.6811883] },
      { name: "GTDLTODA Terminal", coords: [120.987430, 14.684210] },
      { name: "MAPASATODA Terminal", coords: [120.991046, 14.685390] },
      { name: "SFPTODA Terminal", coords: [120.975033, 14.687552] },
      { name: "SFPTODA Sub - Terminal 1", coords: [120.9712381, 14.6828681] },
      { name: "SFPTODA Sub - Terminal 2", coords: [120.9693657, 14.6817543] },
      { name: "PAGUBRIJETODA Terminal", coords: [120.974872, 14.688651] },
      { name: "INTODA Terminal", coords: [120.996975, 14.686742] },
      { name: "GTUTODA Terminal", coords: [121.0087165, 14.6929564] },
      { name: "GTUTODA Terminal 1", coords: [121.008715, 14.693006] },
      { name: "GTUTODA Terminal 2", coords: [121.001192, 14.688084] },
      { name: "SQTODA Terminal", coords: [121.0014923, 14.6878900] },
      { name: "PMUTODA Terminal", coords: [120.999438, 14.686221] },
      { name: "FVTODA Terminal", coords: [120.9881195, 14.7044778] },
      { name: "Macanojoda Terminal", coords: [120.970041, 14.693964] },
      { name: "Market Terminal", coords: [120.9643739, 14.6922034] },
      { name: "MSJDTTODA Terminal", coords: [120.9641026, 14.6924224] },
      { name: "SANPATODA Terminal", coords: [120.9955959, 14.6875985] },
      { name: "SANPATODA Terminal 2", coords: [120.9938922, 14.6942838] },
      { name: "BALMATODA Terminal", coords: [120.9642538, 14.6969740] },
      { name: "BALMATODA Terminal 2", coords: [120.9659856, 14.6993050] },
      { name: "BALMATODA Terminal 3", coords: [120.9680714, 14.7011626] },
      { name: "BALMATODA Terminal 4", coords: [120.9719637, 14.7032287] },
      { name: "BALMATODA Extension Terminal", coords: [120.9787590, 14.7004205] },
      { name: "VCHSTODA Terminal", coords: [120.9793107, 14.6991709] },
      { name: "VCHSTODA Terminal 2", coords: [120.988164, 14.6964136] }
    ];

    const routes = [
      { name: "Route 1", color: "#d64933", stops: ["VGC Terminal", "Karuhatan Terminal", "Maysan Terminal", "MASTODA Terminal", "FATATODA Terminal"] },
      { name: "Route 2", color: "#92dce5", stops: ["Mavanoda Terminal", "ASCTODA Terminal", "MTODA Terminal 1", "EFPTODA Terminal", "DOPTODA Terminal"] },
      { name: "Route 3", color: "#772e25", stops: ["GTDLTODA Terminal", "MAPASATODA Terminal", "SFPTODA Terminal", "INTODA Terminal", "GTUTODA Terminal"] }
    ];

    mapboxgl.accessToken = 'pk.eyJ1IjoidmFsY29tbXV0ZXJzIiwiYSI6ImNtaDF5MDc4bjA5OHAyanM5ODFqdnNlN24ifQ.Icx5SXY6609dcG7ItcfS7A';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [120.9830, 14.7066],
      zoom: 13
    });

    map.addControl(new mapboxgl.NavigationControl());

    let allMarkers = [];

    // Add all markers initially
    terminals.forEach(terminal => {
      const marker = new mapboxgl.Marker({ color: "#007aff" })
        .setLngLat(terminal.coords)
        .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`<b>${terminal.name}</b>`))
        .addTo(map);
      
      allMarkers.push(marker);
    });

    // Show default nearby stops
    showNearbyStops([]);

    // Handle searches
    map.on('load', () => {
      // Check for single terminal search (from main search bar)
      const singleTerminalData = sessionStorage.getItem('searchTerminal');
      if (singleTerminalData) {
        const terminal = JSON.parse(singleTerminalData);
        map.flyTo({ center: terminal.coords, zoom: 16, speed: 1.2 });
        document.getElementById('locationText').textContent = terminal.name;
        sessionStorage.removeItem('searchTerminal');
        return;
      }

      // Check for route search (from/to inputs)
      const fromData = sessionStorage.getItem('searchFrom');
      const toData = sessionStorage.getItem('searchTo');

      if (fromData && toData) {
        const from = JSON.parse(fromData);
        const to = JSON.parse(toData);

        const possibleRoutes = findRoutes(from.name, to.name);

        if (possibleRoutes.length > 0) {
          showRouteOptions(possibleRoutes, from, to);
          drawRoute(possibleRoutes[0], from, to);
        } else {
          alert('No direct routes found between these terminals');
        }

        sessionStorage.removeItem('searchFrom');
        sessionStorage.removeItem('searchTo');
      }
    });

    function findRoutes(fromName, toName) {
      const foundRoutes = [];

      routes.forEach(route => {
        const fromIndex = route.stops.indexOf(fromName);
        const toIndex = route.stops.indexOf(toName);

        if (fromIndex !== -1 && toIndex !== -1) {
          const startIndex = Math.min(fromIndex, toIndex);
          const endIndex = Math.max(fromIndex, toIndex);
          
          foundRoutes.push({
            name: route.name,
            color: route.color,
            stops: route.stops.slice(startIndex, endIndex + 1)
          });
        }
      });

      return foundRoutes;
    }

    function showRouteOptions(possibleRoutes, from, to) {
      const container = document.getElementById('routeOptionsContainer');
      let html = '<div class="route-options-box"><h3>Available Routes</h3>';

      possibleRoutes.forEach((route, index) => {
        html += `
          <div class="route-option-card">
            <div class="route-option-header">
              <span class="route-dot" style="background: ${route.color}"></span>
              <span>${route.name}</span>
            </div>
            <div class="route-stops">${route.stops.join(' → ')}</div>
            <button class="select-route-btn" onclick="selectRoute(${index})">Select This Route</button>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;

      window.currentRoutes = possibleRoutes;
      window.currentFrom = from;
      window.currentTo = to;
    }

    window.selectRoute = function(index) {
      drawRoute(window.currentRoutes[index], window.currentFrom, window.currentTo);
    };

    function drawRoute(route, from, to) {
      // Clear all markers
      allMarkers.forEach(m => m.remove());
      allMarkers = [];

      // Remove old route
      if (map.getLayer('route-line')) {
        map.removeLayer('route-line');
        map.removeSource('route-line');
      }

      // Get coordinates for the route
      const coords = route.stops.map(stopName => {
        const terminal = terminals.find(t => t.name === stopName);
        return terminal ? terminal.coords : null;
      }).filter(c => c !== null);

      // Draw route line
      map.addSource('route-line', {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: coords
          }
        }
      });

      map.addLayer({
        id: 'route-line',
        type: 'line',
        source: 'route-line',
        paint: {
          'line-color': route.color,
          'line-width': 5
        }
      });

      // Fit map to route
      const bounds = new mapboxgl.LngLatBounds();
      coords.forEach(coord => bounds.extend(coord));
      map.fitBounds(bounds, { padding: 60 });

      // Add start marker (green)
      new mapboxgl.Marker({ color: '#00ff00' })
        .setLngLat(from.coords)
        .setPopup(new mapboxgl.Popup().setHTML(`<b>Start:</b> ${from.name}`))
        .addTo(map);

      // Add end marker (red)
      new mapboxgl.Marker({ color: '#ff0000' })
        .setLngLat(to.coords)
        .setPopup(new mapboxgl.Popup().setHTML(`<b>End:</b> ${to.name}`))
        .addTo(map);

      // Update location text
      document.getElementById('locationText').textContent = `${from.name} → ${to.name}`;

      // Update nearby stops to show only terminals along this route
      showNearbyStops(route.stops);
    }

    function showNearbyStops(routeStops) {
      const container = document.getElementById('stopsListContainer');
      
      if (routeStops.length === 0) {
        // Show all terminals if no route selected
        container.innerHTML = terminals.map(terminal => 
          `<div class="stop-row" onclick="flyToTerminal('${terminal.name}')"><span>${terminal.name}</span></div>`
        ).join('');
      } else {
        // Show only terminals along the selected route
        container.innerHTML = routeStops.map(stopName => 
          `<div class="stop-row" onclick="flyToTerminal('${stopName}')"><span>${stopName}</span></div>`
        ).join('');
      }
    }

    window.flyToTerminal = function(terminalName) {
      const terminal = terminals.find(t => t.name === terminalName);
      if (terminal) {
        map.flyTo({ 
          center: terminal.coords, 
          zoom: 16, 
          speed: 1.2 
        });
        document.getElementById('locationText').textContent = terminal.name;
      }
    };
  </script>
</body>
</html>
